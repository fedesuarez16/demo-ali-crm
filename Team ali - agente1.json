{
  "name": "Team ali - agente",
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  COALESCE(l.estado_chat, 1) AS estado_chat,\n  COALESCE(l.whatsapp_id, $1) AS whatsapp_id\nFROM (SELECT 1) dummy\nLEFT JOIN leads l ON l.whatsapp_id = $1\nLIMIT 1;\n",
        "options": {
          "queryReplacement": "={{ $json.normalized.conversation.messages[0].sender.phone_number.replace('+', '') }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1632,
        4384
      ],
      "id": "a211c930-f551-4c2a-9ee8-80484f3acb96",
      "name": "SQL - Cancelar Seguimiento1",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "YRwSgmEmsHeFgOQf",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO leads (whatsapp_id, estado_chat, updated_at)\nVALUES ($1, 1, NOW())\nON CONFLICT (whatsapp_id) \nDO UPDATE SET \n  estado_chat = 1,\n  updated_at = NOW()\nRETURNING whatsapp_id, estado_chat;",
        "options": {
          "queryReplacement": "={{ $('Normalice').item.json.normalized.conversation.messages[0].sender.phone_number }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        368,
        4032
      ],
      "id": "4c2cae5c-7d00-4f0b-80c6-9c19e218e8d8",
      "name": "Set Estado Chat en DB",
      "credentials": {
        "postgres": {
          "id": "YRwSgmEmsHeFgOQf",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://mia-chatwoot.w9weud.easypanel.host//api/v1/accounts/2/conversations/{{ $('Normalice').item.json.normalized.conversation.contact_inbox.id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "axxJevEaPpRy4VJTfHS93LQr"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": {{ JSON.stringify($('RAG Agent1').item.json.output) }},\n  \"message_type\": \"outgoing\",\n  \"private\": false\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4640,
        4144
      ],
      "id": "126f2112-2d72-4eb8-877d-acba6caea513",
      "name": "HTTP Request1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "Xfa8MNHwcRpVe1r7",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "topN": 10
      },
      "type": "@n8n/n8n-nodes-langchain.rerankerCohere",
      "typeVersion": 1,
      "position": [
        3936,
        4848
      ],
      "id": "8a3a4cb9-3a64-40f7-af6a-5aaf50b40ccb",
      "name": "Reranker Cohere1",
      "credentials": {
        "cohereApi": {
          "id": "6mDThtf9ooEIaxHA",
          "name": "CohereApi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "=La herramienta hace busquedas de propiedades y devuelve la ficha de la propiedad con sus valores correspondientes, incluyendo el valor enlace ",
        "tableName": {
          "__rl": true,
          "value": "documents_1",
          "mode": "list",
          "cachedResultName": "documents_1"
        },
        "topK": 30,
        "useReranker": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        3840,
        4640
      ],
      "id": "b42e9d1b-48f0-4891-be51-2d69c3f2c65a",
      "name": "Supabase Vector Store1",
      "credentials": {
        "supabaseApi": {
          "id": "k63Rdkg9hyaaztWV",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "content": "# RAG Agent\n",
        "height": 380,
        "width": 620,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2080,
        4400
      ],
      "id": "7540cf29-b42d-447f-b949-f355e69f68f7",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Vector Store w/ Reranker\n",
        "height": 396,
        "width": 380,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2704,
        4384
      ],
      "id": "39fa6bc0-e84c-4b88-97d7-2071ad868c4c",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=={{ $('Edit Fields1').item.json.mensajeConContexto +  $('Edit Fields1').item.json.audioConContexto  }} ",
        "options": {
          "systemMessage": "=Eres Maga, asistente de AndrÃ©s Ali, Corredor Inmobiliario en RE/MAX Diagonal II â€“ City Bell.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸš¨ REGLA FUNDAMENTAL DE RESPUESTA:\n- Genera SOLO UNA respuesta por mensaje del cliente\n- NUNCA generes mÃºltiples mensajes seguidos\n- DespuÃ©s de cada respuesta, DETENTE y espera la respuesta del cliente\n- NO anticipes ni simules respuestas del cliente\n- NO continues la conversaciÃ³n solo\n\n\nğŸš¨ REGLA ABSOLUTA DE SALIDA (CRÃTICA â€“ PRIORIDAD MÃXIMA)\n\nTu respuesta FINAL serÃ¡ enviada DIRECTAMENTE al cliente final.\n\nâŒ NUNCA debes:\n- Explicar lo que estÃ¡s haciendo\n- Decir que estÃ¡s esperando la respuesta del cliente\n- Hablar en tercera persona\n- Dar instrucciones internas\n- Decir frases como:\n  - \"Perfecto, veo que ya...\"\n  - \"Ahora estoy esperando...\"\n  - \"Una vez que el cliente responda...\"\n  - \"ContinuarÃ© la conversaciÃ³n...\"\n  - \"ğŸ‘\" como respuesta final sin texto\n\nâœ… SIEMPRE debes:\n- Escribir ÃšNICAMENTE el mensaje exacto que recibirÃ­a el cliente por WhatsApp\n- Hablarle DIRECTAMENTE al cliente (segunda persona)\n- Enviar UN SOLO MENSAJE claro y natural\n- Si no corresponde responder, devolver EXACTAMENTE un string vacÃ­o: \"\"\n\nğŸ›‘ Si tu respuesta contiene razonamiento, instrucciones, anÃ¡lisis o meta-comentarios:\nESA RESPUESTA ES INCORRECTA Y NO DEBE SER GENERADA.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ¯ OBJETIVO PRINCIPAL\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nCalificar leads iniciando con un mensaje de apertura cÃ¡lido, luego recopilar informaciÃ³n financiera antes de enviar fichas de propiedades. Tu rol es atender al cliente\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ“ FORMATO DE RESPUESTA OBLIGATORIO\n\n- Genera EXACTAMENTE UN mensaje por turno\n- DespuÃ©s de enviar tu mensaje, TERMINA y espera\n- NUNCA simules o anticipes la respuesta del cliente\n\nğŸš¨ REGLA CRÃTICA: Solo genera mensajes que le dirÃ­as directamente al cliente\n\n-si el cliente envia un audio , pide que escriba el mensaje ya que no podes escuchar audios \n\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸŸ¢ PRIMER MENSAJE (INICIO DE CONVERSACIÃ“N)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n\n\"Hola! Mi nombre es Maga, asistente de Andres Ali de Remax diagonal II. Mientras preparo la informacion para enviarte comentame, tu busqueda es por banco o efectivo?\"\n\n**IMPORTANTE: Antes de enviar el mensaje de apertura, verifica que el contexto incluya la direcciÃ³n de la propiedad. si no especifica ninguna propiedad, pregunta acerca de que propiedad esta consultando**\n\n\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ’¬ TU PERSONALIDAD\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâœ… SÃ© conversacional, cÃ¡lida y cercana\nâœ… Pregunta UNA COSA a la vez\nâœ… MantÃ©n tono profesional pero accesible\nâœ… Usa emojis con moderaciÃ³n\n\nâŒ NO uses: \"che\", \"te copa\", \"dime\", \"hazme\", \"vale\"\nâŒ NO seas robÃ³tica ni formal en exceso\nâŒ NO hagas mÃºltiples preguntas en un solo mensaje\nâŒ NO contestes emojis\nâŒ NO te presentes mas de una vez, solo en el mensaje inicial\n\nSI NO HAY NADA QUE RESPONDER: Devuelve un string vacÃ­o \"\" o un simple \"ğŸ‘\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ“‹ SECUENCIA DE CALIFICACIÃ“N\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSigue este orden (adaptÃ¡ndote al flujo natural):\n\n\n0 PRESUPUESTO\nPregunta: \"En que rango de valor es tu busqueda?\"\n\n1ï¸âƒ£ FORMA DE PAGO  \nPregunta: \"Â¿Tu bÃºsqueda es con banco o efectivo?\"  \nSi responde banco: \"Â¿Ya tenÃ©s la precalificaciÃ³n?\"  \nAlternativa: \"Â¿NecesitÃ¡s vender una propiedad para comprar?\"\n\n2ï¸âƒ£ SITUACIÃ“N FINANCIERA  \nSi mencionÃ³ banco: \"Â¿TenÃ©s preaprobaciÃ³n? Â¿De quÃ© banco?\"  \n\n3ï¸âƒ£ ENVÃO DE FICHA  \nUsa \"Supabase Vector Store\" para buscar la propiedad.  \nEnvÃ­a la ficha COMPLETA con el enlace UNA SOLA VEZ.  \nDespuÃ©s pregunta: \"Â¿Se ajusta a tu busqueda?\"\n\n4ï¸âƒ£ MANEJO DE OBJECIONES DE PRECIO  \n\nSI DICE QUE ES CARO (detecta: \"muy caro\", \"mÃ¡s barato\", \"no me alcanza\", \"fuera de presupuesto\"):  \n- Busca en el contexto \"Alternativas de menor valor\"  \n- Responde:  \n  \"Entiendo que buscÃ¡s algo mÃ¡s econÃ³mico ğŸ’°  \n  Te paso estas alternativas de menor valor:  \n  [Alternativas de menor valor]  \n  Â¿QuerÃ©s que te cuente mÃ¡s sobre alguna?\"\n\nMANEJO DE OBJECIONES DE COMODIDADES(PATIO, DORMITORIOS,ETC):  \n- Busca en el contexto de la misma propiedad por la que consulto y envia el contenido de \"Alternativas de mayor valor(ejemplo:si consulto por propiedad x busca el valor Alternativas de mayor valor correspondiente a esa propiedad\"  \n\n- Usa el mismo formato de respuesta\n\n-Si al cliente no le gusta ninguna opcion, ofrece una busqueda personalizada con andres\n\n5ï¸âƒ£ CIERRE EN LLAMADA (OBLIGATORIO)  \n\nCuando hay interÃ©s real Y ya conoces su situaciÃ³n financiera:  \n- SIEMPRE ofrece llamada con AndrÃ©s  \n- Si muestra interes en tener una llamada o agendan una llama a la herramienta \"agendo llamada\"\n- Usa frases como:  \n  * \"Â¿QuerÃ©s que AndrÃ©s te llame para coordinar la visita?\"  \n  * \"Â¿QuÃ© momento te viene mejor ?\"  \n   \n- no hagas demasiadas preguntas para la llamada\n- solo necesitas saber si quiere que lo llames, no busques un horario especifico\n- si muestra intencion de llamada, solo decile que lo vamos a llamar y despedite sin nada mas, sin agregado solo le decis que lo vamos a llamar\n- Si coordinas una llamada: \"Perfecto queda agendado!\" y llama a la herramienta \"agendo llamada\"\n- Si el usuario muestra intencion de coordinar una llamada llama a la tool \"agendo llamada\"\n-Si pide una visita, primero coordina una llamada con andres\n\n\n6- una vez se empieza a coordinar la llamda usa la herramienta \"agendo llamada\"\n\nâš ï¸ IMPORTANTE:  \n- Si tenes presupuesto y modo de financiacion, ofrece una llamada directamente\n- Nunca confirmas una visita, solo coordinas llamdas\n- NUNCA ofrezcas hora exacta (Ej: \"a las 15hs\")  \n- Si el cliente pide que envies la ficha mandasela de inmediato\n- Si el cliente pide detalles de la propiedad que no tenes, ofrece coordinar una llamada con andres\n- Cuando envias la ficha incluye el link\n- SIEMPRE ofrece rangos (maÃ±ana, tarde, noche)  \n- NO coordines visitas sin pasar por llamada primero  \n- NO ofrezcas llamada si no conoces su preaprobaciÃ³n y presupuesto\n- Se simple, no hagas demasiadas preguntas mas que el rango horario y el dia, con eso cerra la llamada diciendo: \"Perfecto te vamos a estar llamando :)\"\n- si el usuario muestra interes en coordinar una llamada: llama a la tool \"agendo llamada\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ  CAPTACIÃ“N DE PROPIEDADES (VENTA O PERMUTA)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSI EL CLIENTE MENCIONA:\n- \"Tengo una propiedad para vender\"\n- \"Â¿Aceptan permutas?\"\n- \"Necesito vender mi casa primero\"\n- Cualquier variante sobre vender o permutar\n\nSECUENCIA DE CAPTACIÃ“N (pregunta de a UNA por vez):\n\n1ï¸âƒ£ UBICACIÃ“N  \n\"Genial, para poder ayudarte mejor, Â¿en quÃ© zona estÃ¡ ubicada tu propiedad?\"\n\n2ï¸âƒ£ ESCRITURA  \n\"Â¿La propiedad tiene escritura al dÃ­a?\"\n\n3ï¸âƒ£ CARACTERÃSTICAS  \n\"Contame un poco sobre tu propiedad: Â¿cuÃ¡ntos ambientes tiene, metros aproximados, alguna caracterÃ­stica destacada?\"\n\n4ï¸âƒ£ CIERRE EN LLAMADA (OBLIGATORIO)  \nUna vez que tengas ubicaciÃ³n, escritura y caracterÃ­sticas:  \n\"Perfecto, con esta info AndrÃ©s puede darte una mejor orientaciÃ³n ğŸ“  \nÂ¿QuerÃ©s que te llame para hacer una tasaciÃ³n y ver las opciones que tenÃ©s?\"\n\nâš ï¸ IMPORTANTE CAPTACIÃ“N:  \n- NO pidas fotos, videos ni documentaciÃ³n  \n- MantÃ©n el tono conversacional y empÃ¡tico  \n- La llamada es el objetivo final tambiÃ©n en captaciÃ³n  \n- Si menciona permuta Y estÃ¡ buscando comprar, recopila info de AMBAS propiedades\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâš ï¸ REGLAS CRÃTICAS\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. **SIEMPRE verifica que la direcciÃ³n de la propiedad estÃ© clara antes de proceder con la calificaciÃ³n**\n2. Si el cliente consulta sin especificar propiedad, pregunta PRIMERO por cuÃ¡l propiedad estÃ¡ consultando\n3. Cada ficha se envÃ­a UNA SOLA VEZ por propiedad  \n4. Pregunta de a UNA cosa por vez  \n5. La llamada con AndrÃ©s es el cierre OBLIGATORIO de toda conversaciÃ³n exitosa  \n6. NO inventes links ni compartas ningÃºn enlace que no provenga del \"Supabase Vector Store\"\n7. NO ofrezcas ni menciones fotos, videos, planos, recorridos virtuales ni materiales adicionales\n8. El ÃšNICO link que podÃ©s enviar es el que proviene directamente de la herramienta \"Supabase Vector Store\"\n9. Si el contexto no incluye la direcciÃ³n de la propiedad, pregunta nuevamente por cual propiedad estÃ¡ consultando\n10. En captaciÃ³n de propiedades, NO pidas documentaciÃ³n ni fotos, solo info conversacional\n11. NO te presentes mas de una vez, solo en el mensaje inicial\n12. NUNCA agendas una visita, siempre agendas llamadas\n13. si el cliente envia un audio , pide que escriba el mensaje ya que no podes escuchar audios \n\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâœ… RECORDATORIO FINAL\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nTu meta es:\n- Identificar la propiedad de consulta ANTES de calificar\n- Ser Ãºtil y humana  \n- Calificar financieramente al lead (compra) o recopilar info clave (venta/permuta)\n- SIEMPRE cerrar en llamada con AndrÃ©s cuando hay interÃ©s genuino  \n\nLa llamada NO es opcional: es el objetivo final de cada conversaciÃ³n exitosa."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3536,
        4288
      ],
      "id": "9cda4c9a-ca79-4b1c-9d94-024c788fd38b",
      "name": "RAG Agent1"
    },
    {
      "parameters": {
        "contextWindowLength": 7
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        3344,
        4592
      ],
      "id": "b5d60ce2-726b-4013-a677-a29d935e9696",
      "name": "Postgres Chat Memory1",
      "credentials": {
        "postgres": {
          "id": "YRwSgmEmsHeFgOQf",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "audio",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2544,
        4048
      ],
      "id": "0f068069-916e-49c1-b16c-3306b431cb89",
      "name": "Transcribe a recording1",
      "credentials": {
        "openAiApi": {
          "id": "BPTkrfKD8LOqnHgE",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "get-media-base64",
        "instanceName": "={{ $('Webhook1').item.json.body.instance }}",
        "messageId": "={{ $('Webhook1').item.json.body.data.key.id }}"
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        1856,
        4048
      ],
      "id": "c7611a02-fa0d-4866-8fc7-3da956acac1b",
      "name": "Obter m dia em base",
      "credentials": {
        "evolutionApi": {
          "id": "JrhtEnlUegX9ixC7",
          "name": "Evolution account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data.base64",
        "binaryPropertyName": "audio",
        "options": {
          "mimeType": "audio/mp3"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        2160,
        4048
      ],
      "id": "3c3a4c6e-3b73-4d0e-9824-21385f608c0e",
      "name": "Convert to File1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "51ab2396-ecef-4d8e-9c3b-210f1af0412d",
              "leftValue": "={{ $('Normalice').item.json.normalized.message.attachments[0].file_type }}",
              "rightValue": "=audio",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1504,
        4592
      ],
      "id": "389e39f0-e51f-4fa2-b4a0-b16d130fa4f2",
      "name": "If9"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT is_active FROM agent_status WHERE id = 1;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        352,
        4512
      ],
      "id": "da1bb206-2ad9-48ee-b255-b27ef38ddc37",
      "name": "Execute a SQL query3",
      "credentials": {
        "postgres": {
          "id": "YRwSgmEmsHeFgOQf",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3051bcde-ec1d-49aa-854d-19ac7751dcf5",
              "leftValue": "=={{ $json[\"is_active\"] }}",
              "rightValue": "==true",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "010b770d-b628-4c53-8a2a-661ef0d3eb79",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].sender.phone_number }}",
              "rightValue": "=+5492216273335",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1152,
        4608
      ],
      "id": "f0cb15ba-6ef8-45f5-9b05-2dabb64c8f81",
      "name": "If10",
      "executeOnce": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "16bc083f-880d-4a27-a4a0-b482a9bde8da",
              "name": "sessionId",
              "value": "={{ $('Webhook1').item.json.body.conversation.messages[0].id }}",
              "type": "string"
            },
            {
              "id": "b0dac7b9-a371-4bb7-aa88-ebb653237973",
              "name": "mensajeConContexto",
              "value": "={{ $json.contextoManual ? ($json.contextoManual + '\\n\\n' + $json.mensajesTexto) : $json.mensajesTexto + $('Transcribe a recording1').item.json.text}}",
              "type": "string"
            },
            {
              "id": "f6deef97-129a-49cc-b76f-ea7cd6ced223",
              "name": "audioConContexto",
              "value": "={{ $json.contextoManual ? ($json.contextoManual + '\\n\\n' + $json.mensajesTexto) : $json.mensajesTexto + $('Transcribe a recording1').item.json.text}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3344,
        4288
      ],
      "id": "97cd64cc-3d9f-43a5-85cc-3c40e6e6594b",
      "name": "Edit Fields1",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "amount": 30
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2368,
        4800
      ],
      "id": "e733b5aa-816c-45cf-aa8e-d19c28ecaaba",
      "name": "Wait",
      "webhookId": "96c27c05-96e6-490e-ac24-3c38c75c7d9b"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "Mensaje",
        "key": "={{ $('Normalice').item.json.normalized.conversation.messages[0].sender.phone_number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2080,
        4608
      ],
      "id": "02e34ad4-f6c8-44cc-823c-5a32ee7b537d",
      "name": "bufferRedis",
      "credentials": {
        "redis": {
          "id": "IqjVekrFmnlXftuo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Normalice').item.json.normalized.conversation.messages[0].sender.phone_number }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2576,
        4608
      ],
      "id": "2d573bf4-c75e-4cf3-80ae-7235a4430b0c",
      "name": "borrarRedis3",
      "credentials": {
        "redis": {
          "id": "IqjVekrFmnlXftuo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2576,
        4448
      ],
      "id": "55b53a6e-ce69-46ea-99d9-9661679565b2",
      "name": "sinAccion"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Normalice').item.json.normalized.conversation.messages[0].sender.phone_number }}",
        "messageData": "={{ JSON.stringify({\n    message :$('Normalice').item.json.normalized.conversation.messages[0].content ,\nsessionID:$('Normalice').item.json.normalized.conversation.contact_inbox.id ,\ndate_time : $('Webhook1').item.json.body.created_at\n}) }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1808,
        4608
      ],
      "id": "b068c85b-1f3f-40de-9497-f2662c8310c2",
      "name": "pushRedis",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "IqjVekrFmnlXftuo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse(\n  $json.Mensaje\n    .filter(m => m.trim().startsWith('{'))\n    .slice(-1)[0]\n    .split('||')[0]\n    .trim()\n).sessionID }}\n",
                    "rightValue": "={{ $('Normalice').item.json.normalized.conversation.contact_inbox.id }}",
                    "operator": {
                      "type": "number",
                      "operation": "notEquals"
                    },
                    "id": "81c7205c-84c9-480e-8b5a-1a12b5ff7baa"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ignorar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "4fca4c39-e8bf-490b-8e2e-176c95d9156e",
                    "leftValue": "={{\n  (() => {\n    try {\n      const mensaje = $json.Mensaje\n        .filter(m => m.trim().startsWith('{'))\n        .slice(-1)[0]\n        .split('||')[0]\n        .trim();\n      \n      const parsedDate = JSON.parse(mensaje).date_time;\n      \n      // Intentar primero con DateTime.fromISO\n      const dateTime = DateTime.fromISO(parsedDate);\n      \n      // Si es vÃ¡lido, retornar el DateTime\n      if (dateTime.isValid) {\n        return dateTime;\n      }\n      \n      // Si no es vÃ¡lido como ISO, intentar parsearlo como timestamp u otro formato\n      // Intentar como timestamp (nÃºmero)\n      if (!isNaN(parsedDate)) {\n        return DateTime.fromMillis(Number(parsedDate));\n      }\n      \n      // Intentar otros formatos comunes\n      return DateTime.fromSQL(parsedDate) || \n             DateTime.fromHTTP(parsedDate) || \n             DateTime.fromRFC2822(parsedDate) ||\n             parsedDate;\n      \n    } catch (error) {\n      return null;\n    }\n  })()\n}}",
                    "rightValue": "={{ $now.minus(7, 'seconds').toLocal() }}",
                    "operator": {
                      "type": "dateTime",
                      "operation": "before"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Continuar"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Esperar"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2368,
        4528
      ],
      "id": "4b303290-4102-481e-ae69-ca22666651bf",
      "name": "Switch"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7b81f90e-0cdc-42d0-8ec1-7d6a8dd320b6",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero coordinar una llamada sobre el depto de Plaza Paso",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "8cf3774b-e9df-48c3-9873-22ff77e1527f",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero mÃ¡s informaciÃ³n sobre el depto de Plaza Paso",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "7010cb70-2f2c-4ff7-839f-48d477111eda",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero agendar una visita en el depto de Plaza Paso",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "aa409b85-1927-4309-ba09-7f7265342d5b",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero coordinar una llamada sobre Haras del Sur II",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "0ceba8b6-31f6-47ee-b083-962befdce0bb",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero agendar una visita en Haras del Sur II",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "dab8fdb6-e308-407a-8df7-b3cdf0f2b8d4",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero agendar una visita en Haras del Sur II",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "0b6cc0de-2e12-41bd-b17d-dbb7c8e189cf",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero coordinar una llamada sobre 60 e/ 15 y 16",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "428b0979-9ecd-46a1-8dd4-8834cf306456",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero mÃ¡s informaciÃ³n de 60 e/ 15 y 16",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "4f52295a-d3eb-4e6e-b513-fe33922cbccc",
              "leftValue": "={{ $('Normalice').item.json.body.messages[0].content }}",
              "rightValue": "Hola! Quiero agendar una visita en 60 e/ 15 y 16",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -304,
        4224
      ],
      "id": "cfd3b45d-53b3-47af-9937-b5dbcee94b01",
      "name": "If11"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3051bcde-ec1d-49aa-854d-19ac7751dcf5",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].content }}",
              "rightValue": "=Hola! Quiero coordinar una llamada sobre 139 e/ 64 y 65",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "3b5e2fbb-a33f-4256-b2ef-a9fdd934ef50",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero mÃ¡s informaciÃ³n de 139 e/ 64 y 65",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "8eeba288-096a-484f-906b-af240099117f",
              "leftValue": "={{ $('Webhook1').item.json.body.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero agendar una visita en 139 e/ 64 y 65",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "1f7083c6-13be-4d36-87da-55176b393fb7",
              "leftValue": "={{ $('Webhook1').item.json.body.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero coordinar una llamada sobre 27 e/ 496 y 497",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "4a8e9d33-dcb9-46a8-af1c-2903edf6b31b",
              "leftValue": "={{ $('Webhook1').item.json.body.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero mÃ¡s informaciÃ³n de 27 e/ 496 y 497",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "2b47d5b0-de53-4e05-a22c-40ffc5f984a6",
              "leftValue": "={{ $('Webhook1').item.json.body.conversation.messages[0].content }}",
              "rightValue": "Hola! Quiero agendar una visita en 27 e/ 496 y 497",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "9b075d5b-add6-42c9-b391-ef0149736f3f",
              "leftValue": "Hola! Quiero mÃ¡s informaciÃ³n de 60 e/ 15 y 16",
              "rightValue": "={{ $('Webhook1').item.json.body.conversation.messages[0].content }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -32,
        4240
      ],
      "id": "841cc235-c129-42d4-aec5-5dff3a39b645",
      "name": "If12",
      "executeOnce": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6d52bd36-b56f-411d-a5e3-2094e1ea8d73",
              "leftValue": "={{ $json.estado_chat }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1360,
        4384
      ],
      "id": "f069c378-2a39-44ce-b01c-82b99c7a9d28",
      "name": "Is Conv Active?1",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "e73b87b2-76b2-4ac6-bc0a-da3a676e48b0",
              "leftValue": "={{ $('Webhook1').item.json.body.sender.identifier }}",
              "rightValue": "=ad",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -672,
        4208
      ],
      "id": "616ff0d3-fe1e-4f2e-a63b-a7e0b70d522f",
      "name": "If13"
    },
    {
      "parameters": {
        "jsCode": "// ===================================================\n// FORMATEAR HISTORIAL - ÃšLTIMOS 10 MENSAJES\n// ===================================================\n\nconst normalized = $('Normalice').item.json.normalized;\nconst historialResponse = $input.first().json;\n\n// ==============================\n// DATOS DEL CONTACTO\n// ==============================\nconst from = normalized.whatsapp_id || 'desconocido';\nconst contactName = normalized.contact_name || 'Cliente';\n\nconsole.log('=== PROCESANDO HISTORIAL DE CHATWOOT ===');\nconsole.log('From:', from);\nconsole.log('Contact name:', contactName);\n\n// ==============================\n// OBTENER MENSAJES DEL HISTORIAL\n// ==============================\nlet mensajes = [];\n\n// Chatwoot puede devolver array directo o dentro de \"payload\" o \"data\"\nif (Array.isArray(historialResponse)) {\n  mensajes = historialResponse;\n} else if (historialResponse.payload && Array.isArray(historialResponse.payload)) {\n  mensajes = historialResponse.payload;\n} else if (historialResponse.data && Array.isArray(historialResponse.data)) {\n  mensajes = historialResponse.data;\n}\n\nconsole.log('Total mensajes encontrados en historial:', mensajes.length);\n\nif (mensajes.length === 0) {\n  return [{\n    json: {\n      contextoManual: '',\n      sinMensajes: true,\n      from,\n      contactName\n    }\n  }];\n}\n\n// ==============================\n// ORDENAR (mÃ¡s antiguos primero)\n// ==============================\nmensajes.sort((a, b) => {\n  const tA = a.created_at || 0;\n  const tB = b.created_at || 0;\n  return tA - tB;\n});\n\n// ==============================\n// TOMAR ÃšLTIMOS 10 MENSAJES\n// ==============================\nconst mensajesRecientes = mensajes.slice(-10);\n\nconsole.log('Mensajes a procesar (Ãºltimos 10):', mensajesRecientes.length);\n\n// ==============================\n// FORMATEAR CONVERSACIÃ“N\n// ==============================\nconst conversacion = mensajesRecientes\n  .map(msg => {\n    // Ignorar mensajes de actividad (message_type: 2)\n    if (msg.message_type === 2) {\n      return null;\n    }\n\n    // Determinar si es del cliente o del agente\n    // message_type: 0 = incoming (cliente)\n    // message_type: 1 = outgoing (agente/bot)\n    const esCliente = msg.message_type === 0;\n\n    let contenido = msg.content || '';\n\n    // Manejar attachments\n    if (msg.attachments && msg.attachments.length > 0) {\n      const attachment = msg.attachments[0];\n      if (attachment.file_type === 'image') {\n        contenido = `[Imagen${contenido ? ': ' + contenido : ''}]`;\n      } else if (attachment.file_type === 'audio') {\n        contenido = '[Audio]';\n      } else if (attachment.file_type === 'video') {\n        contenido = '[Video]';\n      } else if (attachment.file_type === 'file') {\n        contenido = `[Documento${contenido ? ': ' + contenido : ''}]`;\n      } else {\n        contenido = `[${attachment.file_type}]`;\n      }\n    }\n\n    // Si no hay contenido, saltar\n    if (!contenido) {\n      return null;\n    }\n\n    const quien = esCliente ? 'CLIENTE' : 'TÃš (ANDRÃ‰S)';\n\n    // Convertir timestamp Unix a fecha legible (Argentina)\n    const fecha = new Date(msg.created_at * 1000);\n    const timestamp = fecha.toLocaleString('es-AR', {\n      timeZone: 'America/Argentina/Buenos_Aires',\n      day: '2-digit',\n      month: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n\n    return `[${timestamp}] ${quien}: ${contenido}`;\n  })\n  .filter(Boolean)\n  .join('\\n');\n\n// ==============================\n// CONTEXTO FINAL\n// ==============================\nconst contextoManual = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš ï¸  CONTEXTO IMPORTANTE - AGENTE REACTIVADO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nMientras estuviste INACTIVO, hubo esta conversaciÃ³n donde TÃš (AndrÃ©s) respondiste manualmente:\n\n${conversacion}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nINSTRUCCIONES CRÃTICAS:\n- Retomas ahora la conversaciÃ³n automÃ¡ticamente\n- Tienes TODO el contexto de lo que AndrÃ©s hablÃ³ manualmente\n- NO repitas informaciÃ³n que AndrÃ©s ya dio\n- NO vuelvas a hacer preguntas que AndrÃ©s ya hizo\n- ContinÃºa naturalmente desde el Ãºltimo mensaje\n- Si ya se coordinÃ³ algo, respÃ©talo y no lo cambies\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;\n\nconsole.log('âœ… Contexto manual generado');\nconsole.log('Mensajes procesados:', mensajesRecientes.length);\nconsole.log('Ãšltimos 3 mensajes:', conversacion.split('\\n').slice(-3).join('\\n'));\n\nreturn [{\n  json: {\n    contextoManual,\n    totalMensajes: mensajesRecientes.length,\n    from,\n    contactName,\n    ultimoMensaje: conversacion.split('\\n').pop(),\n    mensajesCompletos: conversacion\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2352,
        5040
      ],
      "id": "57bfda12-4b69-42d3-a550-f7a0a623a56d",
      "name": "Formatear Historial2"
    },
    {
      "parameters": {
        "url": "=https://mia-chatwoot.w9weud.easypanel.host/api/v1/accounts/2/conversations/{{ $('Normalice').item.json.normalized.conversation.id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "axxJevEaPpRy4VJTfHS93LQr"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1136,
        5040
      ],
      "id": "40f19422-9d10-415e-9328-4f5c0bc2da29",
      "name": "Obtener Historial Evolution2",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const estadoAgente = $input.first().json.is_active;\nconst webhookData = $('Webhook1').first().json;\n\n// âœ… ESTRUCTURA CHATWOOT\nconst from = webhookData.body.conversation.contact_inbox.source_id;\nconst texto = webhookData.body.content?.trim().toLowerCase();\nconst conversationId = webhookData.body.conversation.id;\nconst inboxId = webhookData.body.inbox.id;\nconst contactName = webhookData.body.sender.name;\nconst accountId = webhookData.body.account.id;\n\nconsole.log('=== VERIFICANDO REACTIVACIÃ“N ===');\nconsole.log('Estado agente:', estadoAgente);\nconsole.log('Comando recibido:', texto);\nconsole.log('From (nÃºmero):', from);\nconsole.log('Contact Name:', contactName);\nconsole.log('Conversation ID:', conversationId);\nconsole.log('Inbox ID:', inboxId);\nconsole.log('Account ID:', accountId);\n\n// Validar que tenemos los datos mÃ­nimos\nif (!from) {\n  console.log('âŒ No se pudo extraer el nÃºmero del remitente');\n  return [{\n    json: {\n      error: true,\n      motivo: 'No se pudo extraer from del webhook'\n    }\n  }];\n}\n\n// Si el agente estÃ¡ activo Y el comando fue \"...\" (reactivaciÃ³n)\nif (estadoAgente === true && texto === '...') {\n  console.log('ğŸŸ¢ REACTIVACIÃ“N DETECTADA - Sincronizar mensajes desde Chatwoot');\n  \n  return [{\n    json: {\n      is_active: true,\n      requiere_sincronizacion: true,\n      from: from,\n      contactName: contactName,\n      chatwootConversationId: conversationId,\n      chatwootInboxId: inboxId,\n      accountId: accountId\n    }\n  }];\n}\n\n// Si el agente estÃ¡ activo pero NO es comando de reactivaciÃ³n\nif (estadoAgente === true) {\n  console.log('âœ… Agente activo - continuar flujo normal');\n  return [{\n    json: {\n      is_active: true,\n      requiere_sincronizacion: false,\n      from: from,\n      contactName: contactName,\n      conversationId: conversationId,\n      continuar_flujo_normal: true\n    }\n  }];\n}\n\n// Si el agente estÃ¡ inactivo\nconsole.log('ğŸ”´ Agente inactivo');\nreturn [{\n  json: {\n    is_active: false,\n    requiere_sincronizacion: false,\n    from: from,\n    contactName: contactName,\n    conversationId: conversationId\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        4768
      ],
      "id": "837372e4-6a8f-4589-90ea-42e210e6589a",
      "name": "Detectar ReactivaciÃ³n1"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3120,
        4592
      ],
      "id": "9ae75d2b-0430-414f-b7d6-5df6e9091dab",
      "name": "Merge Contexto2",
      "alwaysOutputData": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3051bcde-ec1d-49aa-854d-19ac7751dcf5",
              "leftValue": "=={{ $json[\"is_active\"] }}",
              "rightValue": "==true",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "923aa7ad-0c63-49df-9da8-7429cc9a8e5e",
              "leftValue": "={{ $('Normalice').item.json.normalized.conversation.messages[0].sender.phone_number }}",
              "rightValue": "=+5492216273335",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        336,
        4832
      ],
      "id": "17f549ce-c750-4b9a-b97f-87b6fcbb1dcc",
      "name": "If14",
      "executeOnce": false
    },
    {
      "parameters": {
        "jsCode": "// ===================================================\n// VERIFICAR Y PROGRAMAR SEGUIMIENTO 24H â€” NORMALICE\n// ===================================================\n\nconst normalized = $('Normalice').item.json.normalized;\nconst respuestaEnviada = $input.first().json;\n\n// ==============================\n// EXTRAER DATOS\n// ==============================\nconst remoteJid =\n  normalized.conversation.messages[0]?.sender?.phone_number ||\n  'desconocido';\n\nconst sessionId =\n  normalized.conversation.contact_inbox?.id ||\n  remoteJid;\n\n// Conversation ID lÃ³gico (ya no depende de Chatwoot)\nconst conversationId =\n  normalized.conversation.id ||\n  `${remoteJid}-${sessionId}`;\n\nconsole.log('=== VERIFICAR Y PROGRAMAR SEGUIMIENTO 24H ===');\nconsole.log('Remote JID (phone):', remoteJid);\nconsole.log('Session ID:', sessionId);\nconsole.log('Conversation ID:', conversationId);\n\n// ==============================\n// NO PROCESAR NÃšMERO DE ANDRÃ‰S\n// ==============================\nif (remoteJid === '5492214633333' || remoteJid === '+5492214633333') {\n  console.log('â­ï¸ Saltando nÃºmero de AndrÃ©s');\n  return [];\n}\n\n// ==============================\n// CALCULAR FECHA DE SEGUIMIENTO\n// ==============================\nconst ahora = new Date();\nconst fechaSeguimiento = new Date(\n  ahora.getTime() + (22 * 60 * 60 * 1000)\n);\n\nconst fechaSeguimientoISO = fechaSeguimiento.toISOString();\n\nconsole.log('Fecha seguimiento programada (UTC):', fechaSeguimientoISO);\n\n// ==============================\n// INSERT SEGUIMIENTO (ANTI-DUPLICADOS)\n// ==============================\nreturn [{\n  json: {\n    query: `\n      INSERT INTO cola_seguimientos (\n        remote_jid,\n        session_id,\n        chatwoot_conversation_id,\n        fecha_programada,\n        estado,\n        fecha_ultima_interaccion\n      )\n      SELECT $1, $2, $3, $4::timestamptz, 'pendiente', NOW()\n      WHERE NOT EXISTS (\n        SELECT 1\n        FROM cola_seguimientos\n        WHERE remote_jid = $1\n          AND estado = 'pendiente'\n          AND fecha_programada::date = $4::timestamptz::date\n      )\n      RETURNING id, remote_jid, chatwoot_conversation_id, fecha_programada;\n    `,\n    parameters: [\n      remoteJid,\n      sessionId,\n      conversationId,\n      fechaSeguimientoISO\n    ]\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4320,
        3904
      ],
      "id": "bd03ab2e-8f1b-4dc9-8028-245b3e98302d",
      "name": "Code - Registrar para Seguimiento1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "{{ $json.query }}",
        "options": {
          "queryReplacement": "={{ $json.parameters }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4624,
        3904
      ],
      "id": "5efd054c-a9d1-4866-afc7-220a9183237b",
      "name": "SQL - Agregar a Cola Seguimiento1",
      "credentials": {
        "postgres": {
          "id": "YRwSgmEmsHeFgOQf",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "dd134e67-3aa2-4d6f-ab1f-01793a1dbe7b",
              "leftValue": "={{ $json.normalized.conversation.messages[0].sender.phone_number }}",
              "rightValue": "=5492216273335",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1936,
        4368
      ],
      "id": "929b1e18-e29e-4b62-aa4b-3a134b99c40c",
      "name": "If15"
    },
    {
      "parameters": {
        "jsCode": "const webhookData = $('Webhook1').first().json;\nconst ejecutarSQL = $('Execute a SQL query3').first().json;\n\n// Extraer datos\nconst remoteJid = webhookData?.body?.conversation?.contact_inbox?.source_id;\nconst mensaje = webhookData?.body?.content || '';\nconst pushName = webhookData?.body?.sender?.name || null;\nconst chatwootConversationId = webhookData?.body?.conversation?.id || null;\n\nconsole.log('Remote JID:', remoteJid);\nconsole.log('Mensaje:', mensaje);\n\n// Validaciones\nif (!remoteJid || !mensaje) {\n  console.log('âŒ Faltan datos');\n  return [];\n}\n\nconst whatsappId = remoteJid.replace('+', '');\n\n// No guardar comandos ni mensajes de AndrÃ©s\nconst textoLimpio = mensaje.trim().toLowerCase();\nif (textoLimpio === '..' || textoLimpio === '...' || \n    whatsappId === '5492216273335' || whatsappId === '5492214633333') {\n  console.log('â­ï¸ Saltando mensaje');\n  return [];\n}\n\n// Usar NOW() en vez de pasar timestamp\nconst query = `\n  INSERT INTO mensajes_pendientes (\n    remote_jid,\n    mensaje,\n    push_name,\n    chatwoot_conversation_id,\n    fecha_recibido,\n    estado,\n    intentos_procesamiento\n  )\n  VALUES (\n    '${whatsappId}',\n    '${mensaje.replace(/'/g, \"''\")}',\n    ${pushName ? `'${pushName.replace(/'/g, \"''\")}'` : 'NULL'},\n    ${chatwootConversationId || 'NULL'},\n    NOW(),\n    'pendiente',\n    0\n  )\n  ON CONFLICT (remote_jid, fecha_recibido) \n  DO UPDATE SET\n    mensaje = EXCLUDED.mensaje,\n    push_name = EXCLUDED.push_name,\n    chatwoot_conversation_id = EXCLUDED.chatwoot_conversation_id\n  RETURNING id, remote_jid, mensaje;\n`;\n\nconsole.log('Query generado OK');\n\nreturn [{ json: { query: query } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        5120
      ],
      "id": "4de3df30-0f9b-4a65-8e5d-4132803b8955",
      "name": "Guardar mensaje si inactivo1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5",
          "mode": "list",
          "cachedResultName": "gpt-5"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3344,
        4480
      ],
      "id": "ce8cc666-0d44-4c2d-831d-12e6108d49df",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "BPTkrfKD8LOqnHgE",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "{{ $json.query }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        336,
        5376
      ],
      "id": "8cb49edd-3629-441c-aac9-ad0677dd8416",
      "name": "SQL - Guardar Mensaje Pendiente1",
      "credentials": {
        "postgres": {
          "id": "YRwSgmEmsHeFgOQf",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Lista de JIDs a borrar\nconst jidsABorrar = [\n  \"+5492214957804\"\n];\n\nreturn jidsABorrar.map(jid => ({\n  json: { key: jid }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -352,
        5168
      ],
      "id": "59f54e5a-7bdb-429a-9eee-03a8208d5520",
      "name": "Code7"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=campaÃ±a_ocho:{{ $json.key }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -80,
        5168
      ],
      "id": "60460b33-80dd-460d-88f3-c66e51533ef2",
      "name": "borrarRedis4",
      "credentials": {
        "redis": {
          "id": "IqjVekrFmnlXftuo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const jidsAVerificar = [\n  \n  \"+5492214957804\"\n];\n\nreturn jidsAVerificar.map(jid => ({\n  json: { \n    key: jid,\n    tipo: \"mensaje\" // o el tipo de key que sea\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -352,
        5360
      ],
      "id": "f4b6eef7-045b-4191-a0ed-4c5eb024ce93",
      "name": "Code8"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "campaÃ±a_ocho",
        "key": "=campaÃ±a_ocho:{{ $json.key }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -80,
        5360
      ],
      "id": "5fca9e41-c143-49da-8e24-70b8709407f3",
      "name": "borrarRedis5",
      "credentials": {
        "redis": {
          "id": "IqjVekrFmnlXftuo",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.key }}",
        "value": "1",
        "expire": true,
        "ttl": 86400
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -80,
        4960
      ],
      "id": "d6260eac-19e6-48a5-a5c4-e51d321555a5",
      "name": "Redis2",
      "credentials": {
        "redis": {
          "id": "IqjVekrFmnlXftuo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Agregar un JID a Redis con valor \"1\" y expiraciÃ³n de 24 horas\nconst jidAgregar = \"+5492214957804\";\n\nreturn [{\n  json: {\n    operation: \"set\",\n    key: `campaÃ±a_ocho:${jidAgregar}`,\n    value: \"1\",\n    expire: true,\n    ttl: 86400 // 24 horas en segundos\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -352,
        4960
      ],
      "id": "c1f1dd40-7632-4ecb-9afb-17cbc7bd847f",
      "name": "Code9"
    },
    {
      "parameters": {
        "url": "=https://app.chatwoot.com/api/v1/accounts/135793/conversations/{{ $('Webhook1').item.json.body.data.chatwootConversationId }}/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "iL7EfaPAhg1ocvz4s9m4eSmJ"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2816,
        3952
      ],
      "id": "b2760e7c-e8e7-49a7-9f4d-28a6e27c124b",
      "name": "Obtener Historial Evolution3",
      "credentials": {
        "httpBearerAuth": {
          "id": "lwTUWiP0RaCV5Kuz",
          "name": "Bearer Auth account 3"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const respuestaChatwoot = $input.first().json;\nconst webhookData = $('Webhook1').first().json;\nconst remoteJid = webhookData.body.data.key.remoteJid;\n\nconsole.log('=== PROCESANDO HISTORIAL DE CHATWOOT ===');\n\n// Chatwoot puede devolver array directo o dentro de \"payload\"\nlet mensajes = [];\n\nif (Array.isArray(respuestaChatwoot)) {\n  mensajes = respuestaChatwoot;\n} else if (respuestaChatwoot.payload && Array.isArray(respuestaChatwoot.payload)) {\n  mensajes = respuestaChatwoot.payload;\n} else if (respuestaChatwoot.data && Array.isArray(respuestaChatwoot.data)) {\n  mensajes = respuestaChatwoot.data;\n}\n\nconsole.log('Total mensajes encontrados:', mensajes.length);\n\nif (mensajes.length === 0) {\n  return [{\n    json: {\n      contextoManual: '',\n      sinMensajes: true,\n      remoteJid: remoteJid\n    }\n  }];\n}\n\n// Ordenar por timestamp (mÃ¡s antiguos primero)\nmensajes.sort((a, b) => {\n  const timeA = a.created_at || 0;\n  const timeB = b.created_at || 0;\n  return timeA - timeB;\n});\n\n// Tomar solo los Ãºltimos 30 mensajes\nconst mensajesRecientes = mensajes.slice(-30);\n\nconsole.log('Mensajes a procesar:', mensajesRecientes.length);\n\n// Formatear conversaciÃ³n\nconst conversacion = mensajesRecientes.map(msg => {\n  // En Chatwoot:\n  // message_type: 0 = incoming (cliente)\n  // message_type: 1 = outgoing (agente/bot)\n  // message_type: 2 = activity (sistema)\n  const esDelUsuario = msg.message_type === 0;\n  const esDelAgente = msg.message_type === 1;\n  const esActividad = msg.message_type === 2;\n  \n  // Ignorar mensajes de actividad\n  if (esActividad) {\n    return null;\n  }\n  \n  // Extraer contenido\n  let contenido = msg.content || '';\n  \n  // Si tiene attachments\n  if (msg.attachments && msg.attachments.length > 0) {\n    const attachment = msg.attachments[0];\n    if (attachment.file_type === 'image') {\n      contenido = `[Imagen${contenido ? ': ' + contenido : ''}]`;\n    } else if (attachment.file_type === 'audio') {\n      contenido = '[Audio]';\n    } else if (attachment.file_type === 'video') {\n      contenido = '[Video]';\n    } else if (attachment.file_type === 'file') {\n      contenido = `[Documento${contenido ? ': ' + contenido : ''}]`;\n    } else {\n      contenido = `[${attachment.file_type}]`;\n    }\n  }\n  \n  const quien = esDelUsuario ? 'CLIENTE' : 'TÃš (ANDRÃ‰S)';\n  \n  // Convertir timestamp a fecha legible\n  const fecha = new Date(msg.created_at * 1000);\n  const timestamp = fecha.toLocaleString('es-AR', { \n    timeZone: 'America/Argentina/Buenos_Aires',\n    day: '2-digit',\n    month: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit'\n  });\n  \n  return `[${timestamp}] ${quien}: ${contenido}`;\n}).filter(m => m !== null).join('\\n');\n\n// Crear contexto formateado\nconst contextoManual = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš ï¸  CONTEXTO IMPORTANTE - AGENTE REACTIVADO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nMientras estuviste INACTIVO, hubo esta conversaciÃ³n donde TÃš (AndrÃ©s) respondiste manualmente:\n\n${conversacion}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nINSTRUCCIONES CRÃTICAS:\n- Retomas ahora la conversaciÃ³n automÃ¡ticamente\n- Tienes TODO el contexto de lo que AndrÃ©s hablÃ³ manualmente\n- NO repitas informaciÃ³n que AndrÃ©s ya dio\n- NO vuelvas a hacer preguntas que AndrÃ©s ya hizo\n- ContinÃºa naturalmente desde el Ãºltimo mensaje\n- Si ya se coordinÃ³ algo, respÃ©talo y no lo cambies\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;\n\nconsole.log('âœ… Contexto manual generado');\nconsole.log('Mensajes procesados:', mensajesRecientes.length);\nconsole.log('Ãšltimos 3 mensajes:', conversacion.split('\\n').slice(-3).join('\\n'));\n\nreturn [{\n  json: {\n    contextoManual: contextoManual,\n    totalMensajes: mensajesRecientes.length,\n    remoteJid: remoteJid,\n    ultimoMensaje: conversacion.split('\\n').pop(),\n    mensajesCompletos: conversacion\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3056,
        3952
      ],
      "id": "a619a63b-fba4-41cb-95c7-d9ab461befd2",
      "name": "Formatear Historial3",
      "disabled": true
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3072,
        4208
      ],
      "id": "79b62ff9-e84c-43f3-aab3-8d09cce0b0ab",
      "name": "Merge Contexto3",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// SOLUCIÃ“N: Acceder a nodos anteriores explÃ­citamente\nconst agentOutput = $input.first().json.output || '';\nconst webhookData = $('Webhook1').first().json;\nconst borrarRedisData = $('borrarRedis3').first()?.json;\n\n// âœ… CHATWOOT: Extraer whatsapp_id del source_id\nlet whatsappId = webhookData?.body?.conversation?.contact_inbox?.source_id;\n\n// Normalizar whatsapp_id (quitar prefijos si existen)\nif (whatsappId) {\n  whatsappId = whatsappId.replace('@s.whatsapp.net', '').replace('@c.us', '').replace('+', '');\n}\n\n// âœ… CHATWOOT: Extraer pushName del sender\nconst pushName = webhookData?.body?.sender?.name || null;\nconsole.log('ğŸ“± pushName de Chatwoot:', pushName);\n\n// Extraer mensaje del usuario desde borrarRedis1 o directamente del webhook\nlet userMessage = '';\nif (borrarRedisData?.mensajesTexto) {\n  userMessage = borrarRedisData.mensajesTexto;\n} else {\n  // âœ… CHATWOOT: El contenido estÃ¡ en body.content\n  userMessage = webhookData?.body?.content || '';\n}\n\nconsole.log('=== DATOS EXTRAÃDOS ===');\nconsole.log('WhatsApp ID:', whatsappId);\nconsole.log('Mensaje usuario:', userMessage.substring(0, 100));\nconsole.log('Respuesta agente:', agentOutput.substring(0, 100));\n\nif (!whatsappId) {\n  throw new Error('No se pudo extraer el whatsapp_id. Verifica el flujo.');\n}\n\n// FunciÃ³n para extraer informaciÃ³n del contexto\nfunction extractLeadInfo(userMsg, agentMsg) {\n  const info = {\n    whatsapp_id: whatsappId,\n    nombre: null,\n    presupuesto: null,\n    zona: null,\n    tipo_propiedad: null,\n    forma_pago: null,\n    intencion: null,\n    caracteristicas_buscadas: null,\n    caracteristicas_venta: null,\n    propiedad_interes: null,\n    estado: null,\n    ultima_interaccion: new Date().toISOString()\n  };\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // CALIFICACIÃ“N AUTOMÃTICA POR MENSAJES\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // Contar mensajes del historial de Chatwoot\n  try {\n    const historialData = $('Formatear Historial2').item?.json;\n    const totalMensajes = historialData?.totalMensajes || 0;\n    \n    if (totalMensajes <= 2) {\n      info.estado = 'frÃ­o';\n    } else if (totalMensajes <= 15) {\n      info.estado = 'tibio';\n    } else {\n      info.estado = 'caliente';\n    }\n    console.log(`ğŸ“Š Lead calificado como \"${info.estado}\" (${totalMensajes} mensajes)`);\n  } catch (e) {\n    // Si no se puede acceder al historial, usar frÃ­o por defecto\n    info.estado = 'frÃ­o';\n    console.log('ğŸ“Š Lead calificado como \"frÃ­o\" por defecto (sin historial)');\n  }\n\n  const fullContext = (userMsg + ' ' + agentMsg).toLowerCase();\n  console.log('Contexto completo:', fullContext.substring(0, 200));\n\n  // Extraer intenciÃ³n (comprar o vender)\n  if (fullContext.match(/\\b(quiero comprar|busco comprar|interesa comprar|me interesa|quiero una propiedad|estoy buscando|necesito comprar|busco|info|informaciÃ³n)\\b/)) {\n    info.intencion = 'comprar';\n  } else if (fullContext.match(/\\b(quiero vender|vender mi|tengo una propiedad|quiero publicar|poner en venta)\\b/)) {\n    info.intencion = 'vender';\n  }\n\n  // Extraer tipo de propiedad\n  const tiposPropiedad = {\n    'departamento': /\\b(departamento|depto|dto|dpto)\\b/,\n    'casa': /\\b(casa|vivienda)\\b/,\n    'ph': /\\b(ph|p\\.h\\.|petit hotel)\\b/,\n    'terreno': /\\b(terreno|lote)\\b/,\n    'local': /\\b(local comercial|local)\\b/,\n    'oficina': /\\b(oficina)\\b/,\n    'cochera': /\\b(cochera|garage|garaje)\\b/\n  };\n\n  for (const [tipo, regex] of Object.entries(tiposPropiedad)) {\n    if (fullContext.match(regex)) {\n      info.tipo_propiedad = tipo;\n      break;\n    }\n  }\n\n  // Extraer presupuesto\n  const presupuestoPatterns = [\n    /(?:presupuesto|hasta|mÃ¡ximo|budget|tengo)[\\s:de]*(?:usd?[\\s$]*)?([\\d]+[\\\\.,]?\\d*)\\s*(?:mil|k|millones?|m)?/i,\n    /(?:usd?[\\s$]*)([\\d]+[\\\\.,]?\\d*)\\s*(?:mil|k|millones?|m)/i,\n    /([\\d]+[\\\\.,]?\\d*)\\s*(?:mil|k|millones?|m)\\s*(?:dÃ³lares|dolares|usd|pesos)?/i\n  ];\n\n  for (const pattern of presupuestoPatterns) {\n    const presupuestoMatch = fullContext.match(pattern);\n    if (presupuestoMatch) {\n      let monto = parseFloat(presupuestoMatch[1].replace(',', '.'));\n      if (fullContext.match(/\\bmillones?\\b/)) monto *= 1000000;\n      else if (fullContext.match(/\\b(mil|k)\\b/)) monto *= 1000;\n      info.presupuesto = monto;\n      console.log('Presupuesto encontrado:', monto);\n      break;\n    }\n  }\n\n  // Extraer zona\n  const zonaPatterns = [\n    /\\b(?:en|zona|barrio|ubicaciÃ³n|ubicado en?|por)\\s+(?:de\\s+|la\\s+)?([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\\s]+?)(?:\\s|,|\\.|\\?|$)/i,\n    /\\b(palermo|belgrano|recoleta|puerto madero|caballito|villa crespo|colegiales|nuÃ±ez|saavedra|microcentro|san telmo|balvanera|almagro|flores|barracas|monserrat|retiro|once|abasto|congreso|chacarita|parque patricios|boedo|barrio norte|zona norte|zona sur|zona oeste|centro|city bell|la plata|gonnet|tolosa|villa elisa)\\b/i\n  ];\n\n  for (const pattern of zonaPatterns) {\n    const zonaMatch = fullContext.match(pattern);\n    if (zonaMatch) {\n      const zonaCandidato = zonaMatch[1] ? zonaMatch[1].trim() : zonaMatch[0].trim();\n      if (zonaCandidato.length > 2 && zonaCandidato.length < 50) {\n        info.zona = zonaCandidato.charAt(0).toUpperCase() + zonaCandidato.slice(1);\n        console.log('Zona encontrada:', info.zona);\n        break;\n      }\n    }\n  }\n\n  // Extraer forma de pago\n  if (fullContext.match(/\\b(contado|efectivo|cash|al contado|pago contado|en efectivo|seria en efectivo|compra seria en efectivo)\\b/)) {\n    info.forma_pago = 'contado';\n    console.log('Forma de pago: contado');\n  } else if (fullContext.match(/\\b(financiado|financiaciÃ³n|cuotas|en cuotas|crÃ©dito|a crÃ©dito)\\b/)) {\n    info.forma_pago = 'financiado';\n  } else if (fullContext.match(/\\b(hipotecario|prÃ©stamo|prÃ©stamo hipotecario|con hipoteca|por banco|busqueda es por banco)\\b/)) {\n    info.forma_pago = 'hipotecario';\n  } else if (fullContext.match(/\\b(mixto|parte contado|parte financiado)\\b/)) {\n    info.forma_pago = 'mixto';\n  }\n\n  // Extraer caracterÃ­sticas buscadas\n  const caracBuscadas = [];\n  \n  const ambMatch = fullContext.match(/\\b(\\d+)\\s*(?:ambiente|ambientes|amb)\\b/);\n  if (ambMatch) {\n    caracBuscadas.push(`${ambMatch[1]} ambientes`);\n  }\n  \n  const dormMatch = fullContext.match(/\\b(\\d+)\\s*(?:dormitorio|dormitorios|habitaciÃ³n|habitaciones|cuarto|cuartos)\\b/);\n  if (dormMatch) {\n    caracBuscadas.push(`${dormMatch[1]} dormitorios`);\n  }\n  \n  const baÃ±oMatch = fullContext.match(/\\b(\\d+)\\s*(?:baÃ±o|baÃ±os)\\b/);\n  if (baÃ±oMatch) {\n    caracBuscadas.push(`${baÃ±oMatch[1]} baÃ±os`);\n  }\n  \n  const extrasRegex = /\\b(balcÃ³n|balcon|terraza|jardÃ­n|jardin|patio|parrilla|quincho|cochera|garage|amenities|gym|gimnasio|piscina|pileta|sum|lavadero|baulera)\\b/g;\n  const extras = fullContext.match(extrasRegex);\n  if (extras) {\n    caracBuscadas.push(...[...new Set(extras)]);\n  }\n  \n  if (caracBuscadas.length > 0) {\n    info.caracteristicas_buscadas = caracBuscadas.join(', ');\n    console.log('CaracterÃ­sticas:', info.caracteristicas_buscadas);\n  }\n\n  // Extraer cÃ³digo de propiedad - direcciones\n  const direccionMatch = fullContext.match(/\\b(\\d+\\s*(?:y|e\\/|esq\\.?|bis|entre)\\s*\\d+(?:\\s*y\\s*\\d+)?)\\b/i);\n  if (direccionMatch) {\n    info.propiedad_interes = direccionMatch[1].toUpperCase();\n    console.log('DirecciÃ³n/Propiedad encontrada:', info.propiedad_interes);\n  } else {\n    // Buscar cÃ³digos alfanumÃ©ricos tradicionales\n    const propPatterns = [\n      /\\b(?:propiedad|prop|cÃ³digo|codigo|cod|id|referencia|ref)[\\s:#-]*([a-z0-9]{3,})\\b/i,\n      /\\b(prop[a-z0-9]{2,})\\b/i\n    ];\n    \n    for (const pattern of propPatterns) {\n      const propMatch = fullContext.match(pattern);\n      if (propMatch && propMatch[1] && propMatch[1].length >= 3 && propMatch[1].length <= 20) {\n        const palabrasComunes = ['para', 'por', 'pero', 'porque', 'propiedad', 'puede', 'paso'];\n        if (!palabrasComunes.includes(propMatch[1].toLowerCase())) {\n          info.propiedad_interes = propMatch[1].toUpperCase();\n          console.log('CÃ³digo propiedad encontrado:', info.propiedad_interes);\n          break;\n        }\n      }\n    }\n  }\n\n  // ğŸ†• EXTRAER NOMBRE - CON PUSHNAME COMO FALLBACK\n  // Primero intentar extraer del mensaje\n  const nombreMatch = userMsg.match(/\\b(?:me llamo|mi nombre es|soy|mi nombre)\\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+(?:\\s+[a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+)?)/i);\n  if (nombreMatch) {\n    const nombre = nombreMatch[1].trim();\n    info.nombre = nombre.split(' ').map(word => \n      word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()\n    ).join(' ');\n    console.log('âœ… Nombre del mensaje:', info.nombre);\n  } \n  // Si no se encontrÃ³ en el mensaje, usar pushName de Chatwoot\n  else if (pushName) {\n    info.nombre = pushName.trim();\n    console.log('âœ… Nombre del pushName de Chatwoot:', info.nombre);\n  }\n\n  return info;\n}\n\n// Extraer informaciÃ³n del lead\nconst leadInfo = extractLeadInfo(userMessage, agentOutput);\n\nconsole.log('=== LEAD INFO FINAL ===');\nconsole.log(JSON.stringify(leadInfo, null, 2));\n\n// Construir query SQL - solo con campos no nulos\nconst fields = [];\nconst values = [];\nconst updates = [];\n\nObject.entries(leadInfo).forEach(([key, value]) => {\n  if (value !== null && key !== 'whatsapp_id') {\n    fields.push(key);\n    values.push(value);\n    // ğŸ†• Para el nombre: solo actualizar si el nuevo valor no estÃ¡ vacÃ­o\n    if (key === 'nombre') {\n      updates.push(`${key} = COALESCE(NULLIF(EXCLUDED.${key}, ''), leads.${key})`);\n    } else if (key === 'estado') {\n      // Para el estado: no degradar estados manuales (llamada, visita)\n      // y no bajar de caliente a tibio/frÃ­o\n      updates.push(`${key} = CASE \n        WHEN leads.${key} IN ('llamada', 'visita') THEN leads.${key}\n        WHEN EXCLUDED.${key} = 'caliente' THEN 'caliente'\n        WHEN EXCLUDED.${key} = 'tibio' AND leads.${key} NOT IN ('caliente', 'llamada', 'visita') THEN 'tibio'\n        WHEN leads.${key} IS NULL OR leads.${key} IN ('activo', 'inicial', '') THEN EXCLUDED.${key}\n        ELSE COALESCE(EXCLUDED.${key}, leads.${key})\n      END`);\n    } else {\n      updates.push(`${key} = EXCLUDED.${key}`);\n    }\n  }\n});\n\n// Si no hay campos, solo actualizar ultima_interaccion\nif (fields.length === 0) {\n  fields.push('ultima_interaccion');\n  values.push(leadInfo.ultima_interaccion);\n  updates.push('ultima_interaccion = EXCLUDED.ultima_interaccion');\n}\n\nconst query = `\nINSERT INTO leads (whatsapp_id, ${fields.join(', ')})\nVALUES ($1, ${values.map((_, i) => `$${i + 2}`).join(', ')})\nON CONFLICT (whatsapp_id) \nDO UPDATE SET \n  ${updates.join(',\\n  ')},\n  updated_at = CURRENT_TIMESTAMP\nRETURNING *;\n`;\n\nconst parameters = [leadInfo.whatsapp_id, ...values];\n\nconsole.log('=== QUERY FINAL ===');\nconsole.log('Campos a actualizar:', fields);\nconsole.log('Valores:', parameters);\n\nreturn [{\n  json: {\n    query: query,\n    parameters: parameters,\n    leadInfo: leadInfo,\n    operation: 'upsert',\n    whatsapp_id: leadInfo.whatsapp_id,\n    extracted_data: {\n      user_message: userMessage.substring(0, 200),\n      agent_response: agentOutput.substring(0, 200),\n      pushName: pushName\n    },\n    debug: {\n      whatsapp_found: !!whatsappId,\n      pushname_found: !!pushName,\n      fields_updated: fields,\n      user_msg_length: userMessage.length,\n      agent_msg_length: agentOutput.length\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4320,
        3744
      ],
      "id": "e191ee2c-4326-42cb-9652-5ec5851b7b7c",
      "name": "capturar informacion1",
      "alwaysOutputData": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "{{ $json.query }}",
        "options": {
          "queryReplacement": "={{ $json.parameters }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4624,
        3744
      ],
      "id": "bbec934d-9ab4-49d5-aa7b-368ceff5ca6f",
      "name": "query guardar informacion1",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "YRwSgmEmsHeFgOQf",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatwoot-webhook",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3248,
        4368
      ],
      "id": "43c30a71-c67f-4147-9b45-e71fc1f7f231",
      "name": "Webhook1",
      "webhookId": "74b838db-2731-44af-83e4-627d97234121"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "claude-sonnet-4-5-20250929",
          "cachedResultName": "Claude Sonnet 4.5"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        3456,
        4592
      ],
      "id": "78ea3e1f-f861-4268-bfd8-ecd5b22aae3a",
      "name": "Anthropic Chat Model",
      "credentials": {
        "anthropicApi": {
          "id": "x1cMDDSv3RoaFkK5",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// NORMALIZAR WEBHOOKS - VERSIÃ“N SIMPLE Y SEGURA\n// ============================================\n\ntry {\n  const webhookData = $input.first().json;\n  const body = webhookData.body;\n  const event = body.event;\n\n  console.log('=== WEBHOOK RECIBIDO ===');\n  console.log('Event:', event);\n\n  // ============================================\n  // NORMALIZACIÃ“N BÃSICA\n  // ============================================\n\n  let normalized = {\n    event: event,\n    account: body.account || null,\n    inbox: body.inbox || null,\n    conversation: null,\n    message: null,\n    sender: null,\n    content: null,\n    source_id: null,\n    timestamp: null\n  };\n\n  if (event === 'conversation_created') {\n    // ConversaciÃ³n estÃ¡ en body directamente\n    normalized.conversation = {\n      id: body.id,\n      inbox_id: body.inbox_id,\n      status: body.status,\n      contact_inbox: body.contact_inbox,\n      messages: body.messages || [],\n      meta: body.meta,\n      created_at: body.created_at,\n      updated_at: body.updated_at\n    };\n    \n    const firstMessage = body.messages?.[0];\n    if (firstMessage) {\n      normalized.message = firstMessage;\n      normalized.content = firstMessage.content;\n      normalized.source_id = firstMessage.source_id;\n      normalized.timestamp = firstMessage.created_at;\n      normalized.sender = firstMessage.sender;\n    }\n    \n  } else if (event === 'message_created') {\n    // ConversaciÃ³n estÃ¡ en body.conversation\n    normalized.conversation = body.conversation;\n    normalized.message = {\n      id: body.id,\n      content: body.content,\n      message_type: body.message_type,\n      created_at: body.created_at,\n      source_id: body.source_id,\n      sender_id: body.sender?.id\n    };\n    normalized.content = body.content;\n    normalized.source_id = body.source_id;\n    normalized.timestamp = body.created_at;\n    normalized.sender = body.sender;\n  }\n\n  // Datos comunes\n  normalized.phone_number = normalized.conversation?.contact_inbox?.source_id;\n  normalized.whatsapp_id = normalized.phone_number?.replace('+', '');\n  normalized.contact_name = normalized.sender?.name || 'Desconocido';\n  normalized.conversation_id = normalized.conversation?.id;\n  normalized.inbox_id = normalized.conversation?.inbox_id;\n\n  console.log('Normalizado exitosamente');\n  console.log('TelÃ©fono:', normalized.phone_number);\n  console.log('Evento:', event);\n\n  return [{\n    json: {\n      ...webhookData,\n      normalized: normalized\n    }\n  }];\n\n} catch (error) {\n  console.error('ERROR EN NORMALIZACIÃ“N:', error.message);\n  console.error('Stack:', error.stack);\n  throw error;\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2192,
        4368
      ],
      "id": "0eb811b7-296c-4eeb-b51e-e2114a04e555",
      "name": "Normalice"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "4mtNYrLqBUhzwLjA",
          "mode": "list",
          "cachedResultUrl": "/workflow/4mtNYrLqBUhzwLjA",
          "cachedResultName": "notificacion llamada"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_name": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_name', ``, 'string') }}",
            "confirmation_text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('confirmation_text', ``, 'string') }}",
            "raw_from_agent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('raw_from_agent', ``, 'string') }}",
            "whatsapp_id": "={{ $('Normalice').item.json.body.conversation.contact_inbox.source_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "lead_number",
              "displayName": "lead_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "confirmation_text",
              "displayName": "confirmation_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "raw_from_agent",
              "displayName": "raw_from_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "whatsapp_id",
              "displayName": "whatsapp_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        3680,
        4528
      ],
      "id": "f095fc63-534f-4d97-b501-b486cb64fe4e",
      "name": "agendo llamada"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "dedupe_key",
              "value": "={{'chatwoot:' + $json.body.conversation.id + ':' + $json.body.id}}"
            }
          ]
        },
        "options": {}
      },
      "id": "a326c3be-9383-4652-ae5d-15c1a72350ec",
      "name": "Set Unique Key",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        -2992,
        4144
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{$json.dedupe_key}}",
        "options": {}
      },
      "id": "5b53906c-bd46-4a20-b18c-73a2941d0868",
      "name": "Redis Check",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2800,
        4144
      ],
      "credentials": {
        "redis": {
          "id": "IqjVekrFmnlXftuo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "f758bb14-2153-4993-bb22-84be9ebd4673",
              "leftValue": "={{ $json.propertyName }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "29e39ce9-0c11-40ab-8a1d-6ba98f95e788",
      "name": "IF Duplicate",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2592,
        4144
      ]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('Set Unique Key').item.json.dedupe_key }}",
        "value": "1",
        "expire": true
      },
      "id": "6040cc63-4cf4-4958-8460-9ab58b2e1ce6",
      "name": "Redis Save",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2368,
        4208
      ],
      "credentials": {
        "redis": {
          "id": "IqjVekrFmnlXftuo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "errorMessage": "duplicado"
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        -2352,
        4032
      ],
      "id": "1029b650-3d1b-4db7-a3e4-825b932c5ce3",
      "name": "Stop and Error"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.embeddingsCohere",
      "typeVersion": 1,
      "position": [
        3648,
        4864
      ],
      "id": "7e9724c8-ffde-4f2d-9a87-80642d71db5c",
      "name": "Embeddings Cohere",
      "credentials": {
        "cohereApi": {
          "id": "6mDThtf9ooEIaxHA",
          "name": "CohereApi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        3776,
        4912
      ],
      "id": "dc286faf-ad32-42ea-b419-822e8067df99",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "BPTkrfKD8LOqnHgE",
          "name": "OpenAi account"
        }
      }
    }
  ],
  "pinData": {
    "Webhook1": [
      {
        "json": {
          "headers": {
            "host": "mia-n8n.w9weud.easypanel.host",
            "user-agent": "rest-client/2.1.0 (linux-musl x86_64) ruby/3.4.4p34",
            "content-length": "2473",
            "accept": "application/json",
            "accept-encoding": "gzip;q=1.0,deflate;q=0.6,identity;q=0.3",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "mia-n8n.w9weud.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "61a01b9f8eee",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "account": {
              "id": 2,
              "name": "flip"
            },
            "additional_attributes": {},
            "content_attributes": {},
            "content_type": "text",
            "content": "Hola! Quiero mÃ¡s informaciÃ³n de 38 e/ 5 y 6",
            "conversation": {
              "additional_attributes": {},
              "can_reply": true,
              "channel": "Channel::Whatsapp",
              "contact_inbox": {
                "id": 114,
                "contact_id": 113,
                "inbox_id": 2,
                "source_id": "5492215667026",
                "created_at": "2026-01-10T03:54:13.661Z",
                "updated_at": "2026-01-10T03:54:13.661Z",
                "hmac_verified": false,
                "pubsub_token": "BC3DxzZSb1S6TZFVMojEsAJU"
              },
              "id": 114,
              "inbox_id": 2,
              "messages": [
                {
                  "id": 9694,
                  "content": "Hola! Quiero mÃ¡s informaciÃ³n de 38 e/ 5 y 6",
                  "account_id": 2,
                  "inbox_id": 2,
                  "conversation_id": 114,
                  "message_type": 0,
                  "created_at": 1771192490,
                  "updated_at": "2026-02-15T21:54:50.380Z",
                  "private": false,
                  "status": "sent",
                  "source_id": "wamid.HBgNNTQ5MjIxNTY2NzAyNhUCABIYIEFDMDVFOUQ3M0NBQkU2MDczODBDQjgwNkY4QTQ2Q0ZCAA==",
                  "content_type": "text",
                  "content_attributes": {},
                  "sender_type": "Contact",
                  "sender_id": 113,
                  "external_source_ids": {},
                  "additional_attributes": {},
                  "processed_message_content": "Hola! Quiero mÃ¡s informaciÃ³n de 38 e/ 5 y 6",
                  "sentiment": {},
                  "conversation": {
                    "assignee_id": null,
                    "unread_count": 8,
                    "last_activity_at": 1771192490,
                    "contact_inbox": {
                      "source_id": "5492215667026"
                    }
                  },
                  "sender": {
                    "additional_attributes": {},
                    "custom_attributes": {},
                    "email": null,
                    "id": 113,
                    "identifier": null,
                    "name": "S",
                    "phone_number": "+5492215667026",
                    "thumbnail": "",
                    "blocked": false,
                    "type": "contact"
                  }
                }
              ],
              "labels": [],
              "meta": {
                "sender": {
                  "additional_attributes": {},
                  "custom_attributes": {},
                  "email": null,
                  "id": 113,
                  "identifier": null,
                  "name": "S",
                  "phone_number": "+5492215667026",
                  "thumbnail": "",
                  "blocked": false,
                  "type": "contact"
                },
                "assignee": null,
                "assignee_type": null,
                "team": null,
                "hmac_verified": false
              },
              "status": "open",
              "custom_attributes": {},
              "snoozed_until": null,
              "unread_count": 8,
              "first_reply_created_at": "2026-01-10T03:54:31.958Z",
              "priority": null,
              "waiting_since": 0,
              "agent_last_seen_at": 0,
              "contact_last_seen_at": 0,
              "last_activity_at": 1771192490,
              "timestamp": 1771192490,
              "created_at": 1768017253,
              "updated_at": 1771192490.383722
            },
            "created_at": "2026-02-15T21:54:50.380Z",
            "id": 9694,
            "inbox": {
              "id": 2,
              "name": "Team ali"
            },
            "message_type": "incoming",
            "private": false,
            "sender": {
              "account": {
                "id": 2,
                "name": "flip"
              },
              "additional_attributes": {},
              "avatar": "",
              "custom_attributes": {},
              "email": null,
              "id": 113,
              "identifier": null,
              "name": "S",
              "phone_number": "+5492215667026",
              "thumbnail": "",
              "blocked": false
            },
            "source_id": "wamid.HBgNNTQ5MjIxNTY2NzAyNhUCABIYIEFDMDVFOUQ3M0NBQkU2MDczODBDQjgwNkY4QTQ2Q0ZCAA==",
            "event": "message_created"
          },
          "webhookUrl": "https://mia-n8n.w9weud.easypanel.host/webhook/chatwoot-webhook",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "SQL - Cancelar Seguimiento1": {
      "main": [
        [
          {
            "node": "Is Conv Active?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Estado Chat en DB": {
      "main": [
        [
          {
            "node": "Execute a SQL query3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reranker Cohere1": {
      "ai_reranker": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_reranker",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store1": {
      "ai_tool": [
        [
          {
            "node": "RAG Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "RAG Agent1": {
      "main": [
        [
          {
            "node": "capturar informacion1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code - Registrar para Seguimiento1",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording1": {
      "main": [
        [
          {
            "node": "Obtener Historial Evolution3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Contexto3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Obter m dia em base": {
      "main": [
        [
          {
            "node": "Convert to File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File1": {
      "main": [
        [
          {
            "node": "Transcribe a recording1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If9": {
      "main": [
        [
          {
            "node": "Obter m dia em base",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "pushRedis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query3": {
      "main": [
        [
          {
            "node": "If10",
            "type": "main",
            "index": 0
          },
          {
            "node": "If14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If10": {
      "main": [
        [
          {
            "node": "If9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "RAG Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "bufferRedis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "bufferRedis": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "borrarRedis3": {
      "main": [
        [
          {
            "node": "Merge Contexto2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "pushRedis": {
      "main": [
        [
          {
            "node": "bufferRedis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "sinAccion",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "borrarRedis3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If11": {
      "main": [
        [
          {
            "node": "Set Estado Chat en DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If12": {
      "main": [
        [
          {
            "node": "Set Estado Chat en DB",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Is Conv Active?1": {
      "main": [
        [
          {
            "node": "Execute a SQL query3",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "If13": {
      "main": [
        [
          {
            "node": "Set Estado Chat en DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Historial2": {
      "main": [
        [
          {
            "node": "Merge Contexto2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Historial Evolution2": {
      "main": [
        [
          {
            "node": "Formatear Historial2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detectar ReactivaciÃ³n1": {
      "main": [
        []
      ]
    },
    "Merge Contexto2": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If14": {
      "main": [
        [
          {
            "node": "Obtener Historial Evolution2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar mensaje si inactivo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Registrar para Seguimiento1": {
      "main": [
        [
          {
            "node": "SQL - Agregar a Cola Seguimiento1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If15": {
      "main": [
        [],
        [
          {
            "node": "SQL - Cancelar Seguimiento1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar mensaje si inactivo1": {
      "main": [
        [
          {
            "node": "SQL - Guardar Mensaje Pendiente1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        []
      ]
    },
    "Code7": {
      "main": [
        [
          {
            "node": "borrarRedis4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code8": {
      "main": [
        [
          {
            "node": "borrarRedis5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code9": {
      "main": [
        [
          {
            "node": "Redis2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Historial Evolution3": {
      "main": [
        [
          {
            "node": "Formatear Historial3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Historial3": {
      "main": [
        [
          {
            "node": "Merge Contexto3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Contexto3": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "capturar informacion1": {
      "main": [
        [
          {
            "node": "query guardar informacion1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Normalice",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set Unique Key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sinAccion": {
      "main": [
        []
      ]
    },
    "Anthropic Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "RAG Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Normalice": {
      "main": [
        [
          {
            "node": "If15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agendo llamada": {
      "ai_tool": [
        [
          {
            "node": "RAG Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Set Unique Key": {
      "main": [
        [
          {
            "node": "Redis Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Check": {
      "main": [
        [
          {
            "node": "IF Duplicate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Duplicate": {
      "main": [
        [
          {
            "node": "Stop and Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Redis Save",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Save": {
      "main": [
        []
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Cohere": {
      "ai_embedding": [
        []
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Argentina/Buenos_Aires",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "706886c9-7aa4-4cbd-b8c6-e876a37edd3a",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ee9f9cdde9b6fee62a7d6845e13fb03583e8c082f1cedc5478accdeca64f2246"
  },
  "id": "ejW2YR1lNj3dYsGc",
  "tags": []
}